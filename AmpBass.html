<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Amp Mobile v3 (HTTPS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilizaﾃｧﾃ｣o para sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ef4444;
            border: 2px solid #fff;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 2px;
        }

        .knob-container {
            background: linear-gradient(145deg, #1f2937, #111827);
            border: 1px solid #374151;
        }
        
        .led-on {
            background-color: #ef4444;
            box-shadow: 0 0 15px #ef4444, 0 0 30px #ef4444;
        }
        
        .led-off {
            background-color: #450a0a;
            box-shadow: inset 0 0 5px #000;
        }

        canvas {
            border-bottom: 2px solid #ef4444;
            background: #000;
        }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center shadow-lg sticky top-0 z-10">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-music text-red-500 text-2xl"></i>
            <div>
                <h1 class="text-xl font-bold tracking-wider leading-none">BASS<span class="text-red-500">AMP</span></h1>
                <p class="text-[10px] text-gray-400 uppercase tracking-widest">Versﾃ｣o Interface P2</p>
            </div>
        </div>
        <div id="statusLed" class="w-4 h-4 rounded-full led-off transition-all duration-300"></div>
    </header>

    <!-- Visualizer -->
    <div class="relative w-full h-40 bg-black shrink-0">
        <canvas id="visualizer" class="w-full h-full"></canvas>
        <div class="absolute top-2 right-2 text-xs text-gray-500 font-mono bg-black/50 p-1 rounded">MONITOR DE SINAL</div>
    </div>

    <!-- Controls -->
    <main class="flex-1 p-4 overflow-y-auto pb-20 space-y-6">
        
        <!-- Alerta de Seguranﾃｧa/HTTPS (Novo) -->
        <div id="securityAlert" class="p-3 rounded-lg text-sm flex items-start gap-3 transition-all duration-300">
            <!-- Conteﾃｺdo serﾃ｡ preenchido via JS -->
        </div>

        <!-- Configuraﾃｧﾃ｣o de Hardware -->
        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 shadow-lg">
            <h3 class="text-sm font-bold text-gray-300 mb-3 flex items-center gap-2">
                <i class="fa-solid fa-plug"></i> HARDWARE & TESTE
            </h3>
            
            <!-- Seletor de Entrada -->
            <div class="mb-3">
                <label class="text-xs text-gray-400 block mb-1">Dispositivo de Entrada (Interface/Cabo)</label>
                <select id="audioInputSelect" class="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500">
                    <option value="default">Padrﾃ｣o (Conecte o cabo primeiro)</option>
                </select>
                <p class="text-[10px] text-gray-500 mt-1">Dica: Se "Headset" ou "Wired" nﾃ｣o aparecer, selecione "Default" ou atualize.</p>
            </div>

            <!-- Botﾃｵes de Aﾃｧﾃ｣o -->
            <div class="grid grid-cols-2 gap-3">
                <button id="refreshDevicesBtn" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 px-4 rounded border border-gray-600">
                    <i class="fa-solid fa-rotate mr-1"></i> ATUALIZAR LISTA
                </button>
                <button id="testOutputBtn" class="bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold py-2 px-4 rounded border border-blue-500">
                    <i class="fa-solid fa-volume-high mr-1"></i> TESTAR SAﾃ好A
                </button>
            </div>
        </div>

        <!-- Botﾃ｣o Power Principal -->
        <div class="text-center">
            <button id="powerBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 px-8 rounded-full shadow-lg border-2 border-gray-500 transition transform active:scale-95 flex items-center justify-center gap-2 mx-auto w-full max-w-xs">
                <i class="fa-solid fa-power-off"></i>
                <span id="btnText">LIGAR PROCESSAMENTO</span>
            </button>
            <p class="text-xs text-yellow-500 mt-2 hidden" id="permWarning"><i class="fa-solid fa-triangle-exclamation"></i> Permita o uso do microfone quando solicitado.</p>
        </div>

        <!-- Controles de ﾃ「dio -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Gain -->
            <div class="knob-container p-4 rounded-xl shadow-md border-l-4 border-l-red-500">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-red-400"><i class="fa-solid fa-bolt mr-1"></i> GANHO (INPUT)</label>
                    <span id="gainVal" class="text-xs bg-gray-800 px-2 py-1 rounded">3.0</span>
                </div>
                <!-- Aumentei o maximo para 10 para compensar sinais fracos de interfaces passivas -->
                <input type="range" id="gainSlider" min="0" max="10" step="0.1" value="3" disabled>
                <p class="text-[10px] text-gray-500 mt-1">Aumente se o sinal estiver baixo.</p>
            </div>

            <!-- Equalizador -->
            <div class="knob-container p-4 rounded-xl shadow-md md:col-span-2">
                <div class="flex items-center gap-2 mb-4 border-b border-gray-700 pb-2">
                    <i class="fa-solid fa-sliders text-red-400"></i>
                    <h2 class="font-bold text-gray-200">EQUALIZADOR</h2>
                </div>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-semibold text-gray-300">Graves (100Hz)</label>
                            <span id="lowVal" class="text-xs text-gray-400">0 dB</span>
                        </div>
                        <input type="range" id="lowSlider" min="-20" max="20" step="1" value="0" disabled>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-semibold text-gray-300">Mﾃｩdios (800Hz)</label>
                            <span id="midVal" class="text-xs text-gray-400">0 dB</span>
                        </div>
                        <input type="range" id="midSlider" min="-20" max="20" step="1" value="0" disabled>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-semibold text-gray-300">Agudos (3kHz)</label>
                            <span id="highVal" class="text-xs text-gray-400">0 dB</span>
                        </div>
                        <input type="range" id="highSlider" min="-20" max="20" step="1" value="0" disabled>
                    </div>
                </div>
            </div>

            <!-- Master -->
            <div class="knob-container p-4 rounded-xl shadow-md md:col-span-2 bg-gray-800 border border-gray-600">
                <div class="flex justify-between mb-2">
                    <label class="font-bold text-white"><i class="fa-solid fa-volume-high mr-1"></i> MASTER</label>
                    <span id="volVal" class="text-xs bg-gray-900 px-2 py-1 rounded text-red-500 font-bold">80%</span>
                </div>
                <input type="range" id="volumeSlider" min="0" max="1.5" step="0.05" value="0.8" disabled>
            </div>
        </div>

    </main>

    <script>
        let audioContext;
        let micSource;
        let inputGainNode;
        let lowEQ, midEQ, highEQ;
        let masterGainNode;
        let analyser;
        let isRunning = false;
        let stream;

        // UI Elements
        const powerBtn = document.getElementById('powerBtn');
        const btnText = document.getElementById('btnText');
        const statusLed = document.getElementById('statusLed');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');
        const audioInputSelect = document.getElementById('audioInputSelect');
        const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
        const testOutputBtn = document.getElementById('testOutputBtn');
        const permWarning = document.getElementById('permWarning');
        const securityAlert = document.getElementById('securityAlert'); // Novo

        // Sliders
        const gainSlider = document.getElementById('gainSlider');
        const lowSlider = document.getElementById('lowSlider');
        const midSlider = document.getElementById('midSlider');
        const highSlider = document.getElementById('highSlider');
        const volumeSlider = document.getElementById('volumeSlider');
        
        // Value Labels
        const gainVal = document.getElementById('gainVal');
        const lowVal = document.getElementById('lowVal');
        const midVal = document.getElementById('midVal');
        const highVal = document.getElementById('highVal');
        const volVal = document.getElementById('volVal');

        // --- Seguranﾃｧa e Contexto (Novo) ---

        function checkSecureContext() {
            if (window.isSecureContext) {
                securityAlert.classList.add('bg-green-900/30', 'border', 'border-green-700');
                securityAlert.innerHTML = `
                    <i class="fa-solid fa-lock text-green-400 text-lg"></i>
                    <div>
                        <p class="font-bold text-green-300">Status de Seguranﾃｧa: SEGURO (HTTPS)</p>
                        <p class="text-xs text-green-400">O acesso ao Microfone/Interface ﾃｩ permitido. Clique em LIGAR.</p>
                    </div>
                `;
            } else {
                securityAlert.classList.add('bg-red-900/30', 'border', 'border-red-700');
                securityAlert.innerHTML = `
                    <i class="fa-solid fa-triangle-exclamation text-red-400 text-lg"></i>
                    <div>
                        <p class="font-bold text-red-300">ALERTA CRﾃ控ICO: Nﾃ｣o Seguro (HTTP ou Local)</p>
                        <p class="text-xs text-red-400">O navegador (Chrome/Android) **BLOQUEIA** o Microfone em sites nﾃ｣o-HTTPS. Vocﾃｪ precisa hospedar este site em um endereﾃｧo seguro (HTTPS) para que funcione.</p>
                    </div>
                `;
            }
        }

        // --- Inicializaﾃｧﾃ｣o e Dispositivos ---

        window.addEventListener('load', () => {
            checkSecureContext();
            getDevices();
        });
        refreshDevicesBtn.addEventListener('click', getDevices);

        async function getDevices() {
            // Se nﾃ｣o estiver em contexto seguro, nﾃ｣o adianta listar
            if (!window.isSecureContext) {
                audioInputSelect.innerHTML = '<option value="blocked">ACESSO BLOQUEADO (Nﾃ｣o-HTTPS)</option>';
                return;
            }

            try {
                // Tenta pedir permissﾃ｣o "apenas ﾃ｡udio" para listar os nomes corretamente.
                await navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then((tempStream) => {
                    tempStream.getTracks().forEach(track => track.stop());
                });

                const devices = await navigator.mediaDevices.enumerateDevices();
                audioInputSelect.innerHTML = '';
                
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                
                if (audioInputs.length === 0) {
                    const option = document.createElement('option');
                    option.text = "Nenhuma entrada detectada (Verifique permissﾃｵes)";
                    audioInputSelect.add(option);
                    return;
                }

                audioInputs.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    let label = device.label || `Microfone ${audioInputSelect.length + 1}`;
                    if (label.toLowerCase().includes('headset') || label.toLowerCase().includes('wired')) {
                        label = "沁ｧ ENTRADA AUXILIAR/P2 (Recomendado)";
                        option.selected = true;
                    }
                    option.text = label;
                    audioInputSelect.add(option);
                });

            } catch (error) {
                console.warn('Permissﾃ｣o de microfone negada ou erro ao listar dispositivos:', error);
                // Se a permissﾃ｣o for negada, exibe uma mensagem genﾃｩrica e limpa a lista
                audioInputSelect.innerHTML = '<option value="default">Padrﾃ｣o (Permissﾃ｣o Necessﾃ｡ria)</option>';
            }
        }

        // --- Teste de Saﾃｭda (Output) ---
        testOutputBtn.addEventListener('click', playTestTone);

        function playTestTone() {
            // Cria um contexto temporﾃ｡rio para teste
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const ctx = audioContext || new AudioContext();
            
            // Se o contexto principal estiver parado, tenta resumir/iniciar para garantir o ﾃ｡udio na saﾃｭda
            if (ctx.state === 'suspended') {
                ctx.resume().catch(e => console.error("Erro ao resumir contexto:", e));
            }
            
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.5);
            
            gain.gain.setValueAtTime(0.5, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);

            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
            
            // Visual feedback no botﾃ｣o
            const originalText = testOutputBtn.innerHTML;
            testOutputBtn.innerHTML = '<i class="fa-solid fa-check"></i> TOCANDO...';
            testOutputBtn.classList.replace('bg-blue-700', 'bg-green-600');
            setTimeout(() => {
                testOutputBtn.innerHTML = originalText;
                testOutputBtn.classList.replace('bg-green-600', 'bg-blue-700');
            }, 600);
        }

        // --- Sistema de ﾃ「dio Principal ---

        powerBtn.addEventListener('click', toggleAudio);

        async function toggleAudio() {
            if (isRunning) {
                stopAudio();
            } else {
                if (!window.isSecureContext) {
                    alert("ERRO: O Microfone estﾃ｡ bloqueado. Por favor, use este site em um endereﾃｧo HTTPS (seguro).");
                    return;
                }
                permWarning.classList.remove('hidden');
                await startAudio();
                permWarning.classList.add('hidden');
            }
        }

        async function startAudio() {
            try {
                const selectedDeviceId = audioInputSelect.value;
                
                // 1. Cria/Resumo o AudioContext imediatamente dentro do clique do usuﾃ｡rio
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!audioContext) {
                    audioContext = new AudioContext({ latencyHint: 'interactive' }); // Prioriza a menor latﾃｪncia
                }
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // 2. Solicita o stream (Permissﾃ｣o do Microfone)
                const constraints = {
                    audio: {
                        deviceId: selectedDeviceId !== 'default' ? { exact: selectedDeviceId } : undefined,
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        latency: 0,
                        channelCount: 1 
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // 3. Constrﾃｳi a cadeia de ﾃ｡udio
                micSource = audioContext.createMediaStreamSource(stream);

                inputGainNode = audioContext.createGain();
                inputGainNode.gain.value = parseFloat(gainSlider.value);

                lowEQ = audioContext.createBiquadFilter();
                lowEQ.type = 'lowshelf'; lowEQ.frequency.value = 100; lowEQ.gain.value = parseFloat(lowSlider.value);

                midEQ = audioContext.createBiquadFilter();
                midEQ.type = 'peaking'; midEQ.frequency.value = 800; midEQ.Q.value = 1; midEQ.gain.value = parseFloat(midSlider.value);

                highEQ = audioContext.createBiquadFilter();
                highEQ.type = 'highshelf'; highEQ.frequency.value = 3000; highEQ.gain.value = parseFloat(highSlider.value);

                masterGainNode = audioContext.createGain();
                masterGainNode.gain.value = parseFloat(volumeSlider.value);

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;

                // Conexﾃｵes
                micSource.connect(inputGainNode);
                inputGainNode.connect(lowEQ);
                lowEQ.connect(midEQ);
                midEQ.connect(highEQ);
                highEQ.connect(masterGainNode);
                masterGainNode.connect(analyser);
                analyser.connect(audioContext.destination);

                isRunning = true;
                updateUIState(true);
                drawVisualizer();

            } catch (err) {
                console.error("Erro no Start:", err);
                let message = "Erro ao iniciar. Vocﾃｪ **negou** o acesso ao microfone, ou o dispositivo de entrada estﾃ｡ ocupado.";
                if (err.name === "NotAllowedError" || err.name === "SecurityError") {
                    message = "ERRO DE PERMISSﾃグ: O navegador precisa de permissﾃ｣o para o microfone. Recarregue a pﾃ｡gina e tente novamente.";
                } else if (err.name === "NotFoundError") {
                    message = "ERRO: Nenhum microfone/interface P2 selecionada. Verifique se o cabo estﾃ｡ conectado e se o dispositivo aparece na lista.";
                }
                alert(message);
                permWarning.classList.add('hidden');
                updateUIState(false);
            }
        }

        function stopAudio() {
            if (audioContext) {
                audioContext.close();
                audioContext = null; // Zera o contexto para ser recriado ao ligar
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            isRunning = false;
            updateUIState(false);
        }

        // --- UI & Visualizadores ---

        function updateUIState(active) {
            if (active) {
                btnText.textContent = "DESLIGAR";
                statusLed.classList.remove('led-off');
                statusLed.classList.add('led-on');
                powerBtn.classList.replace('bg-gray-700', 'bg-red-900');
                audioInputSelect.disabled = true; 
                [gainSlider, lowSlider, midSlider, highSlider, volumeSlider].forEach(el => el.disabled = false);
            } else {
                btnText.textContent = "LIGAR PROCESSAMENTO";
                statusLed.classList.remove('led-on');
                statusLed.classList.add('led-off');
                powerBtn.classList.replace('bg-red-900', 'bg-gray-700');
                audioInputSelect.disabled = false;
                [gainSlider, lowSlider, midSlider, highSlider, volumeSlider].forEach(el => el.disabled = true);
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // Listeners dos Sliders
        gainSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            gainVal.textContent = val.toFixed(1);
            if (inputGainNode) inputGainNode.gain.value = val;
        });

        const eqMap = { 'lowSlider': [lowEQ, lowVal], 'midSlider': [midEQ, midVal], 'highSlider': [highEQ, highVal] };
        Object.keys(eqMap).forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                eqMap[id][1].textContent = (val > 0 ? '+' : '') + val + ' dB';
                if (eqMap[id][0]) eqMap[id][0].gain.value = val;
            });
        });

        volumeSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            volVal.textContent = Math.round((val / 1.5) * 100) + '%';
            if (masterGainNode) masterGainNode.gain.value = val;
        });

        function drawVisualizer() {
            if (!isRunning) return;
            requestAnimationFrame(drawVisualizer);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(dataArray);

            if (canvas.width !== canvas.offsetWidth) {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }

            canvasCtx.fillStyle = '#000';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = '#ef4444';
            canvasCtx.beginPath();

            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2;

                if (i === 0) canvasCtx.moveTo(x, y);
                else canvasCtx.lineTo(x, y);

                x += sliceWidth;
            }
            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();
        }
    </script>
</body>
</html>