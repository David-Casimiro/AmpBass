<script>
let ctx, mic, gainNode, master, analyser, stream;
let running=false, micOn=true;

const powerBtn=document.getElementById("powerBtn");
const micBtn=document.getElementById("micBtn");
const gain=document.getElementById("gain");
const volume=document.getElementById("volume");
const scope=document.getElementById("scope");
const c=scope.getContext("2d");
const inputStatus=document.getElementById("inputStatus");

/* ===== DETECTAR USB AUDIO ===== */
async function detectInputDevice(){
 const devices=await navigator.mediaDevices.enumerateDevices();

 const usb=devices.find(d=>
  d.kind==="audioinput" &&
  /usb|audio|codec|interface/i.test(d.label)
 );

 if(usb){
  inputStatus.textContent=`Entrada: ${usb.label || "USB Audio"}`;
  return {deviceId:{exact:usb.deviceId}};
 }

 inputStatus.textContent="Entrada: Microfone interno";
 return true;
}

/* ===== POWER ===== */
powerBtn.onclick=async()=>{
 if(running){
  ctx.close();
  stream.getTracks().forEach(t=>t.stop());
  running=false;
  powerBtn.textContent="LIGAR";
  powerBtn.classList.replace("bg-red-700","bg-green-700");
  inputStatus.textContent="Entrada: desligado";
  return;
 }

 const AudioContext=window.AudioContext||window.webkitAudioContext;
 ctx=new AudioContext({latencyHint:"interactive",sampleRate:48000});
 await ctx.resume();

 const inputConstraint=await detectInputDevice();

 stream=await navigator.mediaDevices.getUserMedia({
  audio:{
   deviceId: inputConstraint.deviceId,
   echoCancellation:false,
   noiseSuppression:false,
   autoGainControl:false,
   channelCount:1
  }
 });

 mic=ctx.createMediaStreamSource(stream);

 gainNode=ctx.createGain();
 gainNode.gain.value=+gain.value;

 master=ctx.createGain();
 master.gain.value=+volume.value;

 analyser=ctx.createAnalyser();
 analyser.fftSize=1024;
 analyser.smoothingTimeConstant=0.85;

 mic.connect(gainNode)
    .connect(master)
    .connect(analyser)
    .connect(ctx.destination);

 running=true;
 powerBtn.textContent="DESLIGAR";
 powerBtn.classList.replace("bg-green-700","bg-red-700");
 draw();
};

/* ===== MIC ON / OFF ===== */
micBtn.onclick=()=>{
 micOn=!micOn;
 if(gainNode) gainNode.gain.value=micOn?+gain.value:0;
 micBtn.textContent=micOn?"MIC ON":"MIC OFF";
};

/* ===== CONTROLES ===== */
gain.oninput=e=>{
 if(gainNode && micOn) gainNode.gain.value=+e.target.value;
};
volume.oninput=e=>{
 if(master) master.gain.value=+e.target.value;
};

/* ===== OSCILOSCÃ“PIO ===== */
function draw(){
 if(!running) return;
 requestAnimationFrame(draw);

 scope.width=scope.offsetWidth;
 scope.height=scope.offsetHeight;

 const data=new Uint8Array(analyser.fftSize);
 analyser.getByteTimeDomainData(data);

 c.fillStyle="#000";
 c.fillRect(0,0,scope.width,scope.height);
 c.strokeStyle="#ef4444";
 c.lineWidth=2;
 c.beginPath();

 for(let i=0;i<data.length;i+=3){
  const x=i*scope.width/data.length;
  const y=data[i]/255*scope.height;
  i?c.lineTo(x,y):c.moveTo(x,y);
 }
 c.stroke();
}
</script>
