<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>BassFX PWA â€” Ampero Mini</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="theme-color" content="#020617">

<!-- iOS / PWA hints -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
html,body{
  background:#020617;
  color:#e5e7eb;
  font-family:system-ui,-apple-system,sans-serif;
  height:100%;
}
.section{
  border:1px solid #1e293b;
  border-radius:18px;
  padding:1rem;
}
label{font-size:.7rem;color:#9ca3af}
canvas{background:#000;border-radius:12px;width:100%;height:120px}
.btn{padding:1rem;border-radius:16px;font-weight:800}
</style>
</head>

<body class="p-4 max-w-md mx-auto flex flex-col min-h-screen">

<header class="text-center mb-3">
  <h1 class="text-xl font-bold">ðŸŽ¸ BassFX PWA</h1>
  <p class="text-[10px] text-gray-400">Ampero Mini â€¢ USB Audio â€¢ Line Ready</p>
</header>

<main class="flex-1">
  <section class="section mb-3">
    <canvas id="scope"></canvas>
    <div class="text-[11px] text-gray-400 mt-2">
      Status: <span id="status">Desconectado</span>
    </div>
  </section>

  <section class="grid grid-cols-2 gap-3 mb-3">
    <button id="power" class="btn bg-green-700">LIGAR</button>
    <button id="mic" class="btn bg-yellow-500 text-black">MIC ON</button>
  </section>

  <section class="section mb-3">
    <label>INPUT GAIN (LINE)</label>
    <input id="gain" type="range" min="0.5" max="1.5" step="0.01" value="1" class="w-full">
  </section>

  <section class="section">
    <label>MASTER</label>
    <input id="volume" type="range" min="0" max="1" step="0.01" value="0.85" class="w-full">
  </section>
</main>

<footer class="text-center text-[10px] text-gray-500 mt-4">
  BassFX â€¢ PWA â€¢ USB Audio
</footer>

<script>
/* =====================================================
   SINGLE-FILE PWA (manifest + serviceWorker inline)
   ===================================================== */
(function(){
  const manifest = {
    name: "BassFX PWA",
    short_name: "BassFX",
    start_url: ".",
    display: "standalone",
    theme_color: "#020617",
    background_color: "#020617",
    description: "BassFX â€” otimizado para Ampero Mini USB",
    icons: [{
      src: "data:image/svg+xml;utf8,"+encodeURIComponent(`
        <svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'>
          <rect width='512' height='512' rx='96' fill='#020617'/>
          <text x='50%' y='55%' text-anchor='middle' font-size='220'>ðŸŽ¸</text>
        </svg>`),
      sizes: "512x512",
      type: "image/svg+xml"
    }]
  };

  const link = document.createElement("link");
  link.rel = "manifest";
  link.href = URL.createObjectURL(new Blob(
    [JSON.stringify(manifest)],
    {type:"application/json"}
  ));
  document.head.appendChild(link);

  if("serviceWorker" in navigator){
    const swCode = `
      self.addEventListener("install", e=>{
        self.skipWaiting();
      });
      self.addEventListener("activate", e=>{
        self.clients.claim();
      });
      self.addEventListener("fetch", e=>{
        e.respondWith(fetch(e.request).catch(()=>new Response("",{status:504})));
      });
    `;
    const swBlob = new Blob([swCode],{type:"text/javascript"});
    navigator.serviceWorker.register(URL.createObjectURL(swBlob));
  }
})();

/* =====================================================
   AUDIO ENGINE â€” AMPER0 MINI USB ONLY
   ===================================================== */
let ctx, source, trim, gainNode, limiter, master, analyser, stream;
let running=false, micOn=true;

const $=id=>document.getElementById(id);
const scope=$("scope"), c=scope.getContext("2d");

async function getAmpero(){
  const devs=await navigator.mediaDevices.enumerateDevices();
  return devs.find(d=>
    d.kind==="audioinput" &&
    /ampero|hotone|usb audio|uac/i.test(d.label)
  );
}

$("power").onclick=async()=>{
  if(running){
    ctx.close();
    stream.getTracks().forEach(t=>t.stop());
    running=false;
    $("power").textContent="LIGAR";
    $("power").className="btn bg-green-700";
    $("status").textContent="Desconectado";
    return;
  }

  const dev=await getAmpero();
  if(!dev){
    alert("Ampero Mini USB nÃ£o detectado");
    return;
  }

  ctx=new (window.AudioContext||webkitAudioContext)({
    latencyHint:"interactive",
    sampleRate:48000
  });

  stream=await navigator.mediaDevices.getUserMedia({
    audio:{
      deviceId:{exact:dev.deviceId},
      channelCount:2,
      sampleRate:48000,
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });

  source=ctx.createMediaStreamSource(stream);

  trim=ctx.createGain(); trim.gain.value=.8;
  gainNode=ctx.createGain(); gainNode.gain.value=+$("gain").value;

  limiter=ctx.createDynamicsCompressor();
  limiter.threshold.value=-6;
  limiter.ratio.value=12;
  limiter.attack.value=0.003;
  limiter.release.value=0.25;

  master=ctx.createGain(); master.gain.value=+$("volume").value;
  analyser=ctx.createAnalyser(); analyser.fftSize=1024;

  source.connect(trim).connect(gainNode)
    .connect(limiter).connect(master)
    .connect(analyser).connect(ctx.destination);

  running=true;
  $("power").textContent="DESLIGAR";
  $("power").className="btn bg-red-700";
  $("status").textContent="Ampero Mini USB conectado";
  draw();
};

$("mic").onclick=()=>{
  micOn=!micOn;
  gainNode && (gainNode.gain.value=micOn?+$("gain").value:0);
  $("mic").textContent=micOn?"MIC ON":"MIC OFF";
};

$("gain").oninput=e=>{
  gainNode && micOn && (gainNode.gain.value=+e.target.value);
};
$("volume").oninput=e=>{
  master && (master.gain.value=+e.target.value);
};

/* =====================================================
   OSCILLOSCOPE
   ===================================================== */
function draw(){
  if(!running) return;
  requestAnimationFrame(draw);

  scope.width=scope.offsetWidth;
  scope.height=scope.offsetHeight;

  const data=new Uint8Array(analyser.fftSize);
  analyser.getByteTimeDomainData(data);

  c.fillStyle="#000";
  c.fillRect(0,0,scope.width,scope.height);
  c.strokeStyle="#ef4444";
  c.lineWidth=2;
  c.beginPath();

  for(let i=0;i<data.length;i+=3){
    const x=i*scope.width/data.length;
    const y=data[i]/255*scope.height;
    i?c.lineTo(x,y):c.moveTo(x,y);
  }
  c.stroke();
}
</script>
</body>
</html>
